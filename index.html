<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DocScanner IA Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-slate-900 text-white font-sans overflow-x-hidden">

    <div class="max-w-lg mx-auto p-4 flex flex-col min-h-screen">
        <header class="py-4 flex justify-between items-center">
            <h1 class="text-2xl font-black text-blue-500 italic uppercase">Scanner <span class="text-white text-[10px] bg-blue-600 px-2 py-1 rounded not-italic ml-1">IA</span></h1>
            <button id="torchBtn" onclick="toggleTorch()" class="hidden bg-slate-800 p-2 rounded-xl border border-slate-700 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            </button>
        </header>

        <div class="relative w-full aspect-[3/4] bg-black rounded-3xl overflow-hidden border-2 border-slate-700 shadow-2xl">
            <video id="webcam" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
            <canvas id="canvas_mask" class="absolute inset-0 w-full h-full z-10 pointer-events-none opacity-40"></canvas>
            <div id="aiOverlay" class="absolute top-4 left-4 z-20 bg-black/60 px-3 py-1 rounded-full text-[10px] font-bold text-blue-400 border border-blue-500/50 uppercase tracking-widest">Initialisation...</div>
        </div>

        <div class="mt-6 space-y-4">
            <div class="bg-slate-800 p-4 rounded-2xl space-y-3 shadow-inner border border-slate-700">
                <input type="text" id="docFileName" placeholder="Nom du document (ex: Certificat Bosch)" class="w-full bg-slate-700 border-none p-3 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
                <select id="catSelect" class="w-full bg-slate-700 border-none p-3 rounded-lg text-sm outline-none"></select>
            </div>

            <button id="captureBtn" class="w-full bg-blue-600 py-5 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all">
                DÉTOURER ET SAUVER PDF
            </button>
        </div>

        <div class="mt-8 pb-10">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest italic">Favoris localisés</h2>
                <span id="scanCount" class="text-[10px] bg-slate-800 px-2 py-1 rounded border border-slate-700">0</span>
            </div>
            <div id="storageHistory" class="space-y-3"></div>
        </div>
    </div>

    <canvas id="procCanvas" style="display:none;"></canvas>

    <script type="module">
        import { ImageSegmenter, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2";

        const video = document.getElementById("webcam");
        const canvasMask = document.getElementById("canvas_mask");
        const ctxMask = canvasMask.getContext("2d");
        const categories = ["01 — IDENTITÉ", "02 — ÉTAT_CIVIL", "03 — ADMINISTRATION", "04 — FINANCES", "05 — FISCALITÉ", "06 — EMPLOI_RH", "07 — PROFESSIONNEL", "08 — LOGEMENT", "09 — ASSURANCE", "10 — SANTÉ", "11 — ÉDUCATION", "12 — JURIDIQUE", "13 — ACHATS", "14 — TRANSPORT", "15 — ÉNERGIE_TÉLÉCOM", "16 — FAMILLE", "17 — CORRESPONDANCE", "18 — PERSONNEL", "19 — ARCHIVES", "20 — AUTRE"];
        
        let imageSegmenter, streamRef, torchOn = false, lastMask = null;

        // Init Catégories
        const select = document.getElementById('catSelect');
        categories.forEach(cat => {
            let opt = document.createElement('option');
            opt.value = cat; opt.innerHTML = cat;
            if(cat.startsWith("13")) opt.selected = true;
            select.appendChild(opt);
        });

        // Init IA Segmentation
        const initIA = async () => {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/wasm");
            imageSegmenter = await ImageSegmenter.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/1/selfie_segmenter.tflite",
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                outputCategoryMask: true
            });
            document.getElementById('aiOverlay').innerText = "IA PRÊTE ✅";
            startCamera();
        };

        async function startCamera() {
            try {
                streamRef = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280 } });
                video.srcObject = streamRef;
                video.addEventListener("loadeddata", predict);
                const track = streamRef.getVideoTracks()[0];
                if (track.getCapabilities().torch) document.getElementById('torchBtn').classList.remove('hidden');
            } catch(e) { document.getElementById('aiOverlay').innerText = "ERREUR CAMÉRA"; }
        }

        window.toggleTorch = async () => {
            torchOn = !torchOn;
            await streamRef.getVideoTracks()[0].applyConstraints({ advanced: [{ torch: torchOn }] });
        };

        async function predict() {
            if (video.paused || video.ended) return;
            const startTimeMs = performance.now();
            imageSegmenter.segmentForVideo(video, startTimeMs, (result) => {
                lastMask = result.categoryMask;
                drawOverlay(result.categoryMask);
            });
            window.requestAnimationFrame(predict);
        }

        function drawOverlay(mask) {
            canvasMask.width = video.clientWidth;
            canvasMask.height = video.clientHeight;
            const maskData = mask.getAsUint8Array();
            const imageData = ctxMask.createImageData(mask.width, mask.height);
            for (let i = 0; i < maskData.length; i++) {
                const val = maskData[i]; 
                imageData.data[i * 4] = 59; imageData.data[i * 4 + 1] = 130; imageData.data[i * 4 + 2] = 246;
                imageData.data[i * 4 + 3] = val > 128 ? 160 : 0;
            }
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = mask.width; tempCanvas.height = mask.height;
            tempCanvas.getContext('2d').putImageData(imageData, 0, 0);
            ctxMask.drawImage(tempCanvas, 0, 0, canvasMask.width, canvasMask.height);
        }

        document.getElementById('captureBtn').onclick = () => {
            if (!lastMask) return alert("IA en cours d'analyse...");
            const { jsPDF } = window.jspdf;
            const proc = document.getElementById('procCanvas');
            const pCtx = proc.getContext('2d');
            const w = video.videoWidth; const h = video.videoHeight;
            proc.width = w; proc.height = h;

            pCtx.drawImage(video, 0, 0);
            const maskData = lastMask.getAsUint8Array();
            const frame = pCtx.getImageData(0, 0, w, h);
            for (let i = 0; i < maskData.length; i++) {
                if (maskData[i] < 128) { 
                    frame.data[i*4]=255; frame.data[i*4+1]=255; frame.data[i*4+2]=255;
                }
            }
            pCtx.putImageData(frame, 0, 0);

            const pdf = new jsPDF({ orientation: w > h ? 'l' : 'p', unit: 'px', format: [w, h] });
            pdf.addImage(proc.toDataURL('image/jpeg', 0.85), 'JPEG', 0, 0, w, h);
            const name = (document.getElementById('docFileName').value || "Scan_IA") + ".pdf";
            pdf.save(name);
            saveToHistory(name, document.getElementById('catSelect').value);
        };

        // GESTION DE L'HISTORIQUE & SUPPRESSION
        function saveToHistory(name, cat) {
            let history = JSON.parse(localStorage.getItem('doc_scans')) || [];
            history.unshift({ id: Date.now(), name, cat, date: new Date().toLocaleDateString('fr-FR') });
            localStorage.setItem('doc_scans', JSON.stringify(history.slice(0, 50)));
            renderHistory();
        }

        window.deleteScan = (id) => {
            if(confirm("Supprimer ce favori de l'historique ?")) {
                let history = JSON.parse(localStorage.getItem('doc_scans')) || [];
                history = history.filter(s => s.id !== id);
                localStorage.setItem('doc_scans', JSON.stringify(history));
                renderHistory();
            }
        };

        function renderHistory() {
            const scans = JSON.parse(localStorage.getItem('doc_scans')) || [];
            document.getElementById('scanCount').innerText = scans.length;
            document.getElementById('storageHistory').innerHTML = scans.map(s => `
                <div class="bg-slate-800 p-4 rounded-2xl flex justify-between items-center border border-slate-700 shadow-lg animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <div class="flex-1 min-w-0 pr-4">
                        <p class="font-bold text-sm text-slate-100 truncate">${s.name}</p>
                        <p class="text-[9px] text-blue-400 font-bold uppercase tracking-tighter">${s.cat} • ${s.date}</p>
                    </div>
                    <button onclick="deleteScan(${s.id})" class="p-2 bg-slate-700 hover:bg-red-900/40 rounded-xl transition-colors text-slate-400 hover:text-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `).join('');
            if(scans.length === 0) {
                document.getElementById('storageHistory').innerHTML = `<p class="text-center text-slate-600 text-[10px] py-10 uppercase tracking-widest font-bold">Aucun document en mémoire</p>`;
            }
        }

        initIA();
        renderHistory();
    </script>
</body>
</html>
