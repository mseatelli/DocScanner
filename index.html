<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DocScanner Pro - Vision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" onload="onOpenCvReady();"></script>
</head>
<body class="bg-slate-900 text-white font-sans overflow-x-hidden">

    <div class="max-w-lg mx-auto p-4 flex flex-col min-h-screen">
        <header class="py-4 flex justify-between items-center">
            <h1 class="text-2xl font-black text-green-500 italic">DocScanner</h1>
            <span id="status" class="text-[10px] bg-red-900 px-2 py-1 rounded">Moteur Vision: OFF</span>
        </header>

        <div class="relative w-full aspect-[3/4] bg-black rounded-3xl overflow-hidden border-2 border-slate-700 shadow-2xl">
            <video id="videoInput" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
            <canvas id="canvasOutput" class="absolute inset-0 w-full h-full z-10 pointer-events-none"></canvas>
            <div id="aiOverlay" class="absolute top-4 left-4 z-20 bg-black/60 px-3 py-1 rounded-full text-[10px] font-bold text-green-400 border border-green-500/50">
                RECHERCHE DOCUMENT...
            </div>
        </div>

        <div class="mt-6 space-y-4">
            <div class="bg-slate-800 p-4 rounded-2xl shadow-inner">
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2 tracking-widest">Classification</label>
                <select id="catSelect" class="w-full bg-slate-700 border-none p-4 rounded-xl text-sm appearance-none focus:ring-2 focus:ring-green-500">
                    </select>
            </div>

            <button onclick="captureAndSave()" id="captureBtn" disabled class="w-full bg-green-600 disabled:bg-slate-800 disabled:text-slate-600 py-5 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-all">
                SCANNER ET ENREGISTRER
            </button>
        </div>

        <div class="mt-8">
            <h2 class="text-xs font-bold text-slate-500 uppercase mb-4 italic">Historique LocalStorage (Persistant)</h2>
            <div id="storageHistory" class="space-y-3"></div>
        </div>
    </div>

    <script>
        const categories = [
            "01 — IDENTITÉ", "02 — ÉTAT_CIVIL", "03 — ADMINISTRATION", "04 — FINANCES",
            "05 — FISCALITÉ", "06 — EMPLOI_RH", "07 — PROFESSIONNEL", "08 — LOGEMENT",
            "09 — ASSURANCE", "10 — SANTÉ", "11 — ÉDUCATION", "12 — JURIDIQUE",
            "13 — ACHATS", "14 — TRANSPORT", "15 — ÉNERGIE_TÉLÉCOM", "16 — FAMILLE",
            "17 — CORRESPONDANCE", "18 — PERSONNEL", "19 — ARCHIVES", "20 — AUTRE"
        ];

        // Injection des 20 catégories
        const select = document.getElementById('catSelect');
        categories.forEach(cat => {
            let opt = document.createElement('option');
            opt.value = cat;
            opt.innerHTML = cat;
            if(cat.startsWith("20")) opt.selected = true;
            select.appendChild(opt);
        });

        let video = document.getElementById('videoInput');
        let src, dst, cap;

        function onOpenCvReady() {
            document.getElementById('status').innerText = "Moteur Vision: ON";
            document.getElementById('status').className = "text-[10px] bg-green-900 px-2 py-1 rounded";
            document.getElementById('captureBtn').disabled = false;
            initCamera();
        }

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }, 
                    audio: false 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    startProcessing();
                };
            } catch (err) {
                alert("Erreur Caméra : Assurez-vous d'être en HTTPS et d'avoir autorisé l'accès.");
            }
        }

        function startProcessing() {
            src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
            dst = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
            cap = new cv.VideoCapture(video);
            
            const process = () => {
                if (!video.srcObject) return;
                cap.read(src);
                cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
                cv.Canny(dst, dst, 50, 150);

                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(dst, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                const canvas = document.getElementById('canvasOutput');
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                let maxArea = 0;
                let maxIdx = -1;
                for (let i = 0; i < contours.size(); ++i) {
                    let area = cv.contourArea(contours.get(i));
                    if (area > 10000 && area > maxArea) {
                        maxArea = area;
                        maxIdx = i;
                    }
                }

                if (maxIdx !== -1) {
                    let approx = new cv.Mat();
                    cv.approxPolyDP(contours.get(maxIdx), approx, 0.02 * cv.arcLength(contours.get(maxIdx), true), true);
                    if (approx.rows === 4) {
                        drawFrame(ctx, approx);
                        document.getElementById('aiOverlay').innerText = "DOCUMENT PRÊT";
                        document.getElementById('aiOverlay').classList.replace('text-green-400', 'text-yellow-400');
                    }
                    approx.delete();
                }
                contours.delete(); hierarchy.delete();
                requestAnimationFrame(process);
            };
            requestAnimationFrame(process);
        }

        function drawFrame(ctx, approx) {
            ctx.beginPath();
            ctx.strokeStyle = "#00FF00";
            ctx.lineWidth = 8;
            let pts = approx.data32S;
            ctx.moveTo(pts[0], pts[1]);
            for (let i = 2; i < pts.length; i += 2) ctx.lineTo(pts[i], pts[i+1]);
            ctx.closePath();
            ctx.stroke();
        }

        function captureAndSave() {
            const cat = document.getElementById('catSelect').value;
            const doc = { id: Date.now(), cat: cat, date: new Date().toLocaleDateString('fr-FR') };
            let scans = JSON.parse(localStorage.getItem('doc_scans')) || [];
            scans.unshift(doc);
            localStorage.setItem('doc_scans', JSON.stringify(scans));
            renderHistory();
        }

        function renderHistory() {
            const scans = JSON.parse(localStorage.getItem('doc_scans')) || [];
            document.getElementById('storageHistory').innerHTML = scans.map(s => `
                <div class="bg-slate-800 p-4 rounded-xl border-l-4 border-green-500 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase font-bold">${s.cat}</p>
                        <p class="text-sm">Document_Scan_${s.id.toString().slice(-5)}</p>
                    </div>
                    <span class="text-[10px] text-slate-600 italic">${s.date}</span>
                </div>
            `).join('');
        }
        renderHistory();
    </script>
</body>
</html>
