<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DocScanner Ultra Clear</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-slate-900 text-white">

    <div class="max-w-lg mx-auto p-4 flex flex-col min-h-screen">
        <header class="py-4 flex justify-between items-center">
            <h1 class="text-2xl font-black text-blue-500 italic uppercase">Scanner <span class="text-white text-[10px] bg-blue-600 px-2 rounded">PRO</span></h1>
            <div id="status" class="text-[10px] bg-green-600 px-2 py-1 rounded font-bold">IA ACTIVE</div>
        </header>

        <div class="relative w-full aspect-[3/4] bg-black rounded-3xl overflow-hidden border-4 border-blue-900/30">
            <video id="webcam" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
            <canvas id="output_canvas" class="absolute inset-0 w-full h-full z-10"></canvas>
            <div id="aiOverlay" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 bg-blue-600 px-4 py-2 rounded-full text-xs font-bold shadow-xl animate-pulse">
                ALIGNEZ LE DOCUMENT
            </div>
        </div>

        <div class="mt-6 space-y-4">
            <div class="flex gap-2">
                 <button onclick="setMode('color')" class="flex-1 bg-slate-800 p-2 rounded-lg text-[10px] font-bold border border-slate-700">COULEUR</button>
                 <button onclick="setMode('bw')" class="flex-1 bg-blue-600 p-2 rounded-lg text-[10px] font-bold border border-blue-400">N&B SCAN</button>
            </div>
            <button id="captureBtn" class="w-full bg-white text-slate-900 py-5 rounded-2xl font-black text-lg shadow-2xl active:scale-95 transition-all">
                NETTOYER ET SAUVER (PDF)
            </button>
        </div>

        <div id="storageHistory" class="mt-8 space-y-2 pb-10"></div>
    </div>

    <canvas id="procCanvas" style="display:none;"></canvas>

    <script type="module">
        import { ObjectDetector, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2";

        const video = document.getElementById("webcam");
        const canvasElement = document.getElementById("output_canvas");
        const canvasCtx = canvasElement.getContext("2d");
        let objectDetector;
        let lastBox = null;
        let scanMode = 'bw';

        window.setMode = (m) => { scanMode = m; };

        const init = async () => {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/wasm");
            objectDetector = await ObjectDetector.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite`,
                    delegate: "GPU"
                },
                scoreThreshold: 0.3,
                runningMode: "VIDEO"
            });
            startCamera();
        };

        async function startCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280 } });
            video.srcObject = stream;
            video.addEventListener("loadeddata", predict);
        }

        async function predict() {
            const detections = await objectDetector.detectForVideo(video, performance.now());
            canvasElement.width = video.clientWidth;
            canvasElement.height = video.clientHeight;
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (detections.detections.length > 0) {
                const box = detections.detections[0].boundingBox;
                lastBox = box;
                
                // Dessin du viseur "Target"
                const x = (box.originX / video.videoWidth) * canvasElement.width;
                const y = (box.originY / video.videoHeight) * canvasElement.height;
                const w = (box.width / video.videoWidth) * canvasElement.width;
                const h = (box.height / video.videoHeight) * canvasElement.height;

                canvasCtx.strokeStyle = "#3b82f6";
                canvasCtx.lineWidth = 2;
                canvasCtx.strokeRect(x, y, w, h);
                // Coins marqués
                canvasCtx.fillStyle = "#3b82f6";
                canvasCtx.fillRect(x-5, y-5, 20, 5); canvasCtx.fillRect(x-5, y-5, 5, 20); // TL
                canvasCtx.fillRect(x+w-15, y-5, 20, 5); canvasCtx.fillRect(x+w, y-5, 5, 20); // TR
            }
            window.requestAnimationFrame(predict);
        }

        document.getElementById('captureBtn').onclick = () => {
            if (!lastBox) return alert("Document non détecté");

            const { jsPDF } = window.jspdf;
            const proc = document.getElementById('procCanvas');
            const pCtx = proc.getContext('2d');

            // 1. On n'extrait QUE la zone détectée par l'IA
            proc.width = lastBox.width;
            proc.height = lastBox.height;
            
            pCtx.drawImage(video, 
                lastBox.originX, lastBox.originY, lastBox.width, lastBox.height,
                0, 0, lastBox.width, lastBox.height
            );

            // 2. Traitement d'image pour la lisibilité (Filtre Scan)
            if (scanMode === 'bw') {
                let imgData = pCtx.getImageData(0, 0, proc.width, proc.height);
                let d = imgData.data;
                for (let i = 0; i < d.length; i += 4) {
                    let r = d[i], g = d[i+1], b = d[i+2];
                    // Augmentation contraste + Seuil
                    let gray = (0.2126 * r + 0.7152 * g + 0.0722 * b);
                    let v = (gray > 120) ? 255 : gray * 0.8; // Blanc pur pour le papier, assombrit le texte
                    d[i] = d[i+1] = d[i+2] = v;
                }
                pCtx.putImageData(imgData, 0, 0);
            }

            const pdf = new jsPDF({
                orientation: proc.width > proc.height ? 'l' : 'p',
                unit: 'px',
                format: [proc.width, proc.height]
            });
            pdf.addImage(proc.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, proc.width, proc.height);
            pdf.save("Scan_Nettoyé.pdf");
            
            saveToHistory("Scan_" + new Date().toLocaleTimeString());
        };

        function saveToHistory(name) {
            let scans = JSON.parse(localStorage.getItem('doc_scans')) || [];
            scans.unshift({ id: Date.now(), name: name, date: new Date().toLocaleDateString() });
            localStorage.setItem('doc_scans', JSON.stringify(scans.slice(0, 10)));
            renderHistory();
        }

        function renderHistory() {
            const scans = JSON.parse(localStorage.getItem('doc_scans')) || [];
            document.getElementById('storageHistory').innerHTML = scans.map(s => `
                <div class="bg-slate-800 p-3 rounded-xl flex justify-between items-center text-[10px]">
                    <span class="font-bold uppercase">${s.name}</span><span class="opacity-50">${s.date}</span>
                </div>
            `).join('');
        }

        init();
        renderHistory();
    </script>
</body>
</html>
