<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DocScanner AI - MediaPipe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-slate-900 text-white font-sans">

    <div class="max-w-lg mx-auto p-4 flex flex-col min-h-screen">
        <header class="py-4 flex justify-between items-center">
            <h1 class="text-2xl font-black text-green-500 italic uppercase">DocScanner <span class="text-white text-xs px-2 py-1 bg-blue-600 rounded ml-2">IA</span></h1>
            <div id="status" class="text-[10px] bg-red-600 px-2 py-1 rounded font-bold">IA DÉCONNECTÉE</div>
        </header>

        <div class="relative w-full aspect-[3/4] bg-black rounded-3xl overflow-hidden border-2 border-slate-700 shadow-2xl">
            <video id="webcam" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
            <canvas id="output_canvas" class="absolute inset-0 w-full h-full z-10 pointer-events-none"></canvas>
            <div id="aiOverlay" class="absolute top-4 left-4 z-20 bg-black/60 px-3 py-1 rounded-full text-[10px] font-bold text-blue-400 border border-blue-500/50">
                CHARGEMENT DES MODÈLES GOOGLE...
            </div>
        </div>

        <div class="mt-6 space-y-4">
            <input type="text" id="docName" placeholder="Nom du document" class="w-full bg-slate-800 border-none p-4 rounded-2xl text-white outline-none focus:ring-2 focus:ring-blue-500">
            <button id="captureBtn" class="w-full bg-blue-600 py-5 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-all">
                CAPTURER AVEC IA
            </button>
        </div>

        <div id="storageHistory" class="mt-8 space-y-2 pb-10"></div>
    </div>

    <script type="module">
        import { ObjectDetector, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2";

        const video = document.getElementById("webcam");
        const canvasElement = document.getElementById("output_canvas");
        const canvasCtx = canvasElement.getContext("2d");
        const status = document.getElementById("status");
        let objectDetector;

        // 1. Initialiser le détecteur d'objets (IA)
        const initializeObjectDetector = async () => {
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/wasm"
            );
            objectDetector = await ObjectDetector.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite`,
                    delegate: "GPU"
                },
                scoreThreshold: 0.3, // Sensibilité
                runningMode: "VIDEO"
            });
            status.innerText = "IA PRÊTE";
            status.className = "text-[10px] bg-green-600 px-2 py-1 rounded font-bold";
            startCamera();
        };

        // 2. Lancer la caméra
        async function startCamera() {
            const constraints = { video: { facingMode: "environment" } };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.addEventListener("loadeddata", predictWebcam);
        }

        // 3. Boucle de détection
        async function predictWebcam() {
            const detections = await objectDetector.detectForVideo(video, performance.now());
            displayDetections(detections);
            window.requestAnimationFrame(predictWebcam);
        }

        // 4. Affichage du cadre IA
        function displayDetections(result) {
            canvasElement.width = video.clientWidth;
            canvasElement.height = video.clientHeight;
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            result.detections.forEach((detection) => {
                // On ne cherche que les objets qui ressemblent à un "book" ou "paper" ou "laptop" (le modèle est généraliste)
                const label = detection.categories[0].categoryName;
                
                // Dessiner si c'est un objet rectangulaire
                const { originX, originY, width, height } = detection.boundingBox;
                
                // Conversion des coordonnées
                const x = (originX / video.videoWidth) * canvasElement.width;
                const y = (originY / video.videoHeight) * canvasElement.height;
                const w = (width / video.videoWidth) * canvasElement.width;
                const h = (height / video.videoHeight) * canvasElement.height;

                canvasCtx.strokeStyle = "#3b82f6";
                canvasCtx.lineWidth = 4;
                canvasCtx.strokeRect(x, y, w, h);
                
                document.getElementById('aiOverlay').innerText = "OBJET DÉTECTÉ ✅";
            });
            
            if(result.detections.length === 0) {
                document.getElementById('aiOverlay').innerText = "ANALYSE DE LA SCÈNE...";
            }
        }

        // 5. Capture PDF
        document.getElementById('captureBtn').onclick = () => {
            const { jsPDF } = window.jspdf;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCanvas.getContext('2d').drawImage(video, 0, 0);
            
            const pdf = new jsPDF({
                orientation: video.videoWidth > video.videoHeight ? 'l' : 'p',
                unit: 'px',
                format: [video.videoWidth, video.videoHeight]
            });
            pdf.addImage(tempCanvas.toDataURL('image/jpeg'), 'JPEG', 0, 0, video.videoWidth, video.videoHeight);
            pdf.save("Scan_IA.pdf");
        };

        initializeObjectDetector();
    </script>
</body>
</html>
