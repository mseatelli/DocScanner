<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DocScanner Pro - Gestion d'Historique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="https://docs.opencv.org/4.5.4/opencv.min.js" onload="onOpenCvReady();"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-slate-900 text-white font-sans overflow-x-hidden">

    <div class="max-w-lg mx-auto p-4 flex flex-col min-h-screen">
        <header class="py-4 flex justify-between items-center">
            <h1 class="text-2xl font-black text-green-500 italic">DocScanner</h1>
            <span id="status" class="text-[10px] bg-red-900 px-2 py-1 rounded font-bold uppercase">Moteur Off</span>
        </header>

        <div class="relative w-full aspect-[3/4] bg-black rounded-3xl overflow-hidden border-2 border-slate-700 shadow-2xl">
            <video id="videoInput" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
            <canvas id="canvasOutput" class="absolute inset-0 w-full h-full z-10 pointer-events-none"></canvas>
            <div id="aiOverlay" class="absolute top-4 left-4 z-20 bg-black/60 px-3 py-1 rounded-full text-[10px] font-bold text-green-400 border border-green-500/50">
                LANCEMENT...
            </div>
        </div>

        <div class="mt-6 space-y-4">
            <div class="bg-slate-800 p-4 rounded-2xl shadow-inner space-y-3">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Nom du document</label>
                    <input type="text" id="docFileName" placeholder="Ex: Facture_Bosch_Janvier" 
                           class="w-full bg-slate-700 border-none p-3 rounded-lg text-sm text-white focus:ring-2 focus:ring-green-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Classification</label>
                    <select id="catSelect" class="w-full bg-slate-700 border-none p-3 rounded-lg text-sm appearance-none focus:ring-2 focus:ring-green-500 text-white outline-none">
                        </select>
                </div>
            </div>

            <button onclick="captureAndDownload()" id="captureBtn" disabled class="w-full bg-green-600 disabled:bg-slate-800 py-5 rounded-2xl font-black text-lg active:scale-95 transition-all shadow-lg shadow-green-900/20">
                TÉLÉCHARGER LE PDF
            </button>
        </div>

        <div class="mt-8 pb-10">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xs font-bold text-slate-500 uppercase italic">Historique LocalStorage</h2>
                <button onclick="clearAllHistory()" class="text-[10px] text-red-400 font-bold hover:underline">TOUT SUPPRIMER</button>
            </div>
            <div id="storageHistory" class="space-y-2">
                </div>
        </div>
    </div>

    <canvas id="captureCanvas" style="display:none;"></canvas>

    <script>
        const { jsPDF } = window.jspdf;
        const categories = ["01 — IDENTITÉ", "02 — ÉTAT_CIVIL", "03 — ADMINISTRATION", "04 — FINANCES", "05 — FISCALITÉ", "06 — EMPLOI_RH", "07 — PROFESSIONNEL", "08 — LOGEMENT", "09 — ASSURANCE", "10 — SANTÉ", "11 — ÉDUCATION", "12 — JURIDIQUE", "13 — ACHATS", "14 — TRANSPORT", "15 — ÉNERGIE_TÉLÉCOM", "16 — FAMILLE", "17 — CORRESPONDANCE", "18 — PERSONNEL", "19 — ARCHIVES", "20 — AUTRE"];
        
        const select = document.getElementById('catSelect');
        categories.forEach(cat => {
            let opt = document.createElement('option');
            opt.value = cat; opt.innerHTML = cat;
            if(cat.startsWith("13")) opt.selected = true;
            select.appendChild(opt);
        });

        let video = document.getElementById('videoInput');
        let src, dst, cap;

        function onOpenCvReady() {
            document.getElementById('status').innerText = "VISION PRÊTE";
            document.getElementById('status').className = "text-[10px] bg-green-600 px-2 py-1 rounded font-bold";
            document.getElementById('captureBtn').disabled = false;
            initCamera();
        }

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                video.srcObject = stream;
                video.onplay = () => { setTimeout(startProcessing, 800); };
            } catch (err) { alert("Erreur caméra : " + err); }
        }

        function startProcessing() {
            const width = video.videoWidth;
            const height = video.videoHeight;
            if (width === 0) { setTimeout(startProcessing, 200); return; }

            src = new cv.Mat(height, width, cv.CV_8UC4);
            dst = new cv.Mat(height, width, cv.CV_8UC1);
            cap = new cv.VideoCapture(video);
            
            function process() {
                try {
                    cap.read(src);
                    cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
                    cv.GaussianBlur(dst, dst, new cv.Size(9, 9), 0);
                    cv.Canny(dst, dst, 40, 100);
                    
                    let contours = new cv.MatVector();
                    let hierarchy = new cv.Mat();
                    cv.findContours(dst, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                    const canvas = document.getElementById('canvasOutput');
                    const ctx = canvas.getContext('2d');
                    canvas.width = video.clientWidth;
                    canvas.height = video.clientHeight;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    const scaleX = canvas.width / width;
                    const scaleY = canvas.height / height;

                    let maxArea = 0, bestApprox = null;
                    for (let i = 0; i < contours.size(); ++i) {
                        let cnt = contours.get(i);
                        let area = cv.contourArea(cnt);
                        if (area > 5000) {
                            let approx = new cv.Mat();
                            cv.approxPolyDP(cnt, approx, 0.02 * cv.arcLength(cnt, true), true);
                            if (approx.rows === 4 && area > maxArea) {
                                maxArea = area;
                                if(bestApprox) bestApprox.delete();
                                bestApprox = approx;
                            } else { approx.delete(); }
                        }
                    }

                    if (bestApprox) {
                        ctx.beginPath();
                        ctx.strokeStyle = "#00FF00";
                        ctx.lineWidth = 5;
                        let pts = bestApprox.data32S;
                        ctx.moveTo(pts[0] * scaleX, pts[1] * scaleY);
                        for (let i = 2; i < pts.length; i += 2) ctx.lineTo(pts[i] * scaleX, pts[i+1] * scaleY);
                        ctx.closePath(); ctx.stroke();
                        document.getElementById('aiOverlay').innerText = "DOCUMENT DÉTECTÉ ✅";
                        bestApprox.delete();
                    } else {
                        document.getElementById('aiOverlay').innerText = "RECHERCHE DOCUMENT...";
                    }
                    contours.delete(); hierarchy.delete();
                } catch (e) { console.log(e); }
                requestAnimationFrame(process);
            }
            requestAnimationFrame(process);
        }

        async function captureAndDownload() {
            const cat = document.getElementById('catSelect').value;
            const customName = document.getElementById('docFileName').value.trim();
            const fileName = customName ? `${customName}.pdf` : `Doc_${cat.split(' ')[0]}_${Date.now()}.pdf`;

            const captureCanvas = document.getElementById('captureCanvas');
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            const ctx = captureCanvas.getContext('2d');
            ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            
            const pdf = new jsPDF({
                orientation: video.videoWidth > video.videoHeight ? 'l' : 'p',
                unit: 'px',
                format: [video.videoWidth, video.videoHeight]
            });
            pdf.addImage(captureCanvas.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, video.videoWidth, video.videoHeight);
            pdf.save(fileName);

            let scans = JSON.parse(localStorage.getItem('doc_scans')) || [];
            scans.unshift({ id: Date.now(), cat: cat, date: new Date().toLocaleDateString('fr-FR'), file: fileName });
            localStorage.setItem('doc_scans', JSON.stringify(scans));
            
            document.getElementById('docFileName').value = "";
            renderHistory();
        }

        function deleteOne(id) {
            if(confirm("Supprimer ce document de l'historique ?")) {
                let scans = JSON.parse(localStorage.getItem('doc_scans')) || [];
                scans = scans.filter(s => s.id !== id);
                localStorage.setItem('doc_scans', JSON.stringify(scans));
                renderHistory();
            }
        }

        function clearAllHistory() {
            if(confirm("Voulez-vous vraiment effacer TOUT l'historique ?")) {
                localStorage.removeItem('doc_scans');
                renderHistory();
            }
        }

        function renderHistory() {
            const scans = JSON.parse(localStorage.getItem('doc_scans')) || [];
            document.getElementById('storageHistory').innerHTML = scans.map(s => `
                <div class="bg-slate-800 p-4 rounded-xl border-l-4 border-green-500 flex justify-between items-center text-xs mb-2">
                    <div class="flex-1 overflow-hidden mr-2">
                        <p class="font-bold text-slate-200 truncate">${s.file}</p>
                        <p class="text-[10px] text-slate-500 uppercase font-bold">${s.cat}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="text-slate-600 text-[10px]">${s.date}</span>
                        <button onclick="deleteOne(${s.id})" class="text-red-500 hover:text-red-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>`).join('');
        }
        renderHistory();
    </script>
</body>
</html>
